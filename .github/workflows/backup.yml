name: Backup a Repositorio Externo

on:
  schedule:
    # Ejecuta cada domingo a las 2:00 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch: # Permite ejecutar manualmente

jobs:
  backup-to-external:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repositorio actual
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Obtiene todo el historial
        
    - name: Configurar fecha y variables
      id: date
      run: |
        echo "date=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT
        echo "short_date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        echo "BACKUP_REPO=chakielzero/chakielweb-backup" >> $GITHUB_ENV
        
    - name: Crear estructura de backup
      run: |
        mkdir -p backup-data
        
        # InformaciÃ³n del repositorio
        echo "=== BACKUP DEL REPOSITORIO chakielzero.github.io ===" > backup-data/backup-info.md
        echo "" >> backup-data/backup-info.md
        echo "## ğŸ“Š InformaciÃ³n del Backup" >> backup-data/backup-info.md
        echo "- **Fecha**: $(date)" >> backup-data/backup-info.md
        echo "- **Repositorio origen**: ${{ github.repository }}" >> backup-data/backup-info.md
        echo "- **Commit actual**: $(git rev-parse HEAD)" >> backup-data/backup-info.md
        echo "- **Rama**: $(git branch --show-current)" >> backup-data/backup-info.md
        echo "- **Ãšltimo commit**: $(git log -1 --pretty=format:'%h - %an, %ar : %s')" >> backup-data/backup-info.md
        echo "" >> backup-data/backup-info.md
        
        # EstadÃ­sticas del repositorio
        echo "## ğŸ“ˆ EstadÃ­sticas" >> backup-data/backup-info.md
        echo "- **Total de archivos**: $(find . -type f -not -path './.git/*' -not -path './backup-data/*' | wc -l)" >> backup-data/backup-info.md
        echo "- **Archivos HTML**: $(find . -name '*.html' -not -path './.git/*' | wc -l)" >> backup-data/backup-info.md
        echo "- **Archivos CSS**: $(find . -name '*.css' -not -path './.git/*' | wc -l)" >> backup-data/backup-info.md
        echo "- **Archivos JS**: $(find . -name '*.js' -not -path './.git/*' | wc -l)" >> backup-data/backup-info.md
        echo "- **ImÃ¡genes**: $(find . \( -name '*.jpg' -o -name '*.png' -o -name '*.gif' -o -name '*.svg' \) -not -path './.git/*' | wc -l)" >> backup-data/backup-info.md
        echo "" >> backup-data/backup-info.md
        
        # Lista de archivos
        echo "## ğŸ“ Archivos incluidos" >> backup-data/backup-info.md
        echo "\`\`\`" >> backup-data/backup-info.md
        find . -type f -not -path './.git/*' -not -path './backup-data/*' | sort >> backup-data/backup-info.md
        echo "\`\`\`" >> backup-data/backup-info.md
        
        # Crear archivo comprimido del cÃ³digo fuente
        tar -czf backup-data/source-code-${{ steps.date.outputs.date }}.tar.gz \
          --exclude='.git' \
          --exclude='backup-data' \
          --exclude='node_modules' \
          --exclude='.github' \
          .
          
        # Crear backup del historial git (solo los commits mÃ¡s recientes)
        git bundle create backup-data/git-history-${{ steps.date.outputs.date }}.bundle HEAD~50..HEAD 2>/dev/null || \
        git bundle create backup-data/git-history-${{ steps.date.outputs.date }}.bundle --all
        
    - name: Checkout repositorio de backup
      uses: actions/checkout@v4
      with:
        repository: ${{ env.BACKUP_REPO }}
        token: ${{ secrets.BACKUP_TOKEN }}
        path: backup-repo
      continue-on-error: true
      
    - name: Inicializar repositorio si estÃ¡ vacÃ­o
      run: |
        if [ ! -d "backup-repo/.git" ]; then
          echo "Repositorio vacÃ­o, inicializando..."
          mkdir -p backup-repo
          cd backup-repo
          git init
          git remote add origin https://github.com/${{ env.BACKUP_REPO }}.git
          
          # Configurar auth
          git config --local http.https://github.com/.extraheader "AUTHORIZATION: basic $(echo -n x-access-token:${{ secrets.BACKUP_TOKEN }} | base64)"
          
          # Crear commit inicial
          echo "# ğŸ”„ Backups de chakielroms.com" > README.md
          echo "" >> README.md
          echo "Repositorio inicializado automÃ¡ticamente por GitHub Actions" >> README.md
          
          git add README.md
          git config --local user.email "segundariocuenta@gmail.com"
          git config --local user.name "Chakielzero"
          git commit -m "ğŸ‰ InicializaciÃ³n automÃ¡tica del repositorio de backups"
          
          # Crear rama main y push
          git branch -M main
          git push -u origin main
        else
          echo "Repositorio ya existe y estÃ¡ inicializado"
        fi
        
    - name: Organizar backup en repositorio externo
      run: |
        cd backup-repo
        
        # Crear estructura de carpetas por fecha
        YEAR=$(date +'%Y')
        MONTH=$(date +'%m-%B')
        mkdir -p "backups/$YEAR/$MONTH"
        
        # Mover archivos de backup
        cp ../backup-data/* "backups/$YEAR/$MONTH/"
        
        # Crear o actualizar README del repositorio de backup
        cat > README.md << 'EOF'
        # ğŸ”„ Backups de chakielroms.com
        
        Este repositorio contiene backups automÃ¡ticos del sitio web [chakielroms.com](https://chakielroms.com).
        
        ## ğŸŒ Repositorio origen
        - **Sitio web**: [chakielroms.com](https://chakielroms.com)
        - **Repositorio principal**: [chakielzero.github.io](https://github.com/chakielzero/chakielzero.github.io)
        - **GitHub Pages**: [chakielzero.github.io](https://chakielzero.github.io)
        
        ## ğŸ“ Estructura
        
        ```
        backups/
        â”œâ”€â”€ 2025/
        â”‚   â”œâ”€â”€ 01-January/
        â”‚   â”œâ”€â”€ 02-February/
        â”‚   â””â”€â”€ ...
        â””â”€â”€ README.md
        ```
        
        ## ğŸ“Š InformaciÃ³n de Backups
        
        - **Frecuencia**: Semanal (domingos 2:00 AM UTC)
        - **Contenido**: CÃ³digo fuente completo + historial Git
        - **RetenciÃ³n**: Ãšltimos 12 backups (3 meses)
        - **AutomatizaciÃ³n**: GitHub Actions
        - **Repositorio**: Privado ğŸ”’
        
        ## ğŸ” Contenido de cada backup
        
        - `backup-info.md`: InformaciÃ³n detallada del backup
        - `source-code-YYYY-MM-DD_HH-MM-SS.tar.gz`: CÃ³digo fuente comprimido
        - `git-history-YYYY-MM-DD_HH-MM-SS.bundle`: Historial Git reciente
        
        ## ğŸ“… Ãšltimo backup
        
        **Fecha**: $(date)  
        **Estado**: âœ… Completado automÃ¡ticamente
        
        ## ğŸš€ Restaurar backup
        
        Para restaurar un backup:
        
        1. Descargar el archivo `.tar.gz` deseado
        2. Extraer: `tar -xzf source-code-YYYY-MM-DD_HH-MM-SS.tar.gz`
        3. Para historial Git: `git clone backup.bundle restored-repo`
        
        ---
        *ğŸ¤– Generado automÃ¡ticamente por GitHub Actions desde [chakielzero.github.io](https://github.com/chakielzero/chakielzero.github.io)*
        EOF
        
        # Crear Ã­ndice de backups
        echo "# ğŸ“‹ Ãndice de Backups" > BACKUP_INDEX.md
        echo "" >> BACKUP_INDEX.md
        echo "| Fecha | Archivos | TamaÃ±o | Commits |" >> BACKUP_INDEX.md
        echo "|-------|----------|---------|---------|" >> BACKUP_INDEX.md
        
        # Agregar entrada actual
        FILECOUNT=$(find "backups/$YEAR/$MONTH" -name "source-code-*.tar.gz" -exec tar -tzf {} \; 2>/dev/null | wc -l || echo "N/A")
        FILESIZE=$(du -h "backups/$YEAR/$MONTH/source-code-"*.tar.gz 2>/dev/null | cut -f1 || echo "N/A")
        
        echo "| ${{ steps.date.outputs.short_date }} | $FILECOUNT | $FILESIZE | âœ… |" >> BACKUP_INDEX.md
        
    - name: Commit y push al repositorio de backup
      run: |
        cd backup-repo
        
        git config --local user.email "backup-action@github.com"
        git config --local user.name "Backup Bot"
        
        git add .
        
        if git diff --staged --quiet; then
          echo "No hay cambios para commitear en el backup"
        else
          git commit -m "ğŸ”„ Backup automÃ¡tico de chakielroms.com - ${{ steps.date.outputs.date }}

          ğŸ“Š InformaciÃ³n del backup:
          - Repositorio origen: ${{ github.repository }}
          - Commit: ${{ github.sha }}
          - Fecha: $(date)
          - Archivos respaldados: $(find ../backup-data -name '*.tar.gz' -exec tar -tzf {} \; 2>/dev/null | wc -l || echo 'N/A')
          
          ğŸ¤– Generado automÃ¡ticamente por GitHub Actions"
          
          git push
        fi
        
    - name: Limpiar backups antiguos (opcional)
      run: |
        cd backup-repo
        
        # Mantener solo los Ãºltimos 12 backups (3 meses si es semanal)
        find backups/ -name "source-code-*.tar.gz" -type f -printf '%T@ %p\n' | sort -n | head -n -12 | cut -d' ' -f2- | xargs -r rm
        find backups/ -name "git-history-*.bundle" -type f -printf '%T@ %p\n' | sort -n | head -n -12 | cut -d' ' -f2- | xargs -r rm
        find backups/ -name "backup-info.md" -type f -printf '%T@ %p\n' | sort -n | head -n -12 | cut -d' ' -f2- | xargs -r rm
        
        # Eliminar carpetas vacÃ­as
        find backups/ -type d -empty -delete 2>/dev/null || true
        
        # Commit de la limpieza si hay cambios
        git add .
        
        if git diff --staged --quiet; then
          echo "No hay backups antiguos para limpiar"
        else
          git commit -m "ğŸ§¹ Limpieza de backups antiguos - ${{ steps.date.outputs.date }}"
          git push
        fi
        
    - name: NotificaciÃ³n de Ã©xito
      run: |
        echo "âœ… Backup completado exitosamente"
        echo "ğŸ“ Repositorio de backup: ${{ env.BACKUP_REPO }}"
        echo "ğŸ“… Fecha: ${{ steps.date.outputs.date }}"
        echo "ğŸ”— Ver backup: https://github.com/${{ env.BACKUP_REPO }}"
